"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[690],{2145:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"module-01-ros2/week-05/ch06-nav2-basics","title":"Navigation with Nav2","description":"Learning Objectives","source":"@site/docs/module-01-ros2/week-05/ch06-nav2-basics.md","sourceDirName":"module-01-ros2/week-05","slug":"/module-01-ros2/week-05/ch06-nav2-basics","permalink":"/AI_COURSE_book/docs/module-01-ros2/week-05/ch06-nav2-basics","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/module-01-ros2/week-05/ch06-nav2-basics.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"id":"ch06-nav2-basics","title":"Navigation with Nav2","sidebar_label":"Navigation with Nav2","sidebar_position":2},"sidebar":"textbookSidebar","previous":{"title":"Robot Modeling with URDF","permalink":"/AI_COURSE_book/docs/module-01-ros2/week-05/ch05-urdf-models"},"next":{"title":"Module 2: Digital Twin (Weeks 6-7)","permalink":"/AI_COURSE_book/docs/module-02-digital-twin"}}');var r=i(4848),a=i(8453);const l={id:"ch06-nav2-basics",title:"Navigation with Nav2",sidebar_label:"Navigation with Nav2",sidebar_position:2},o="Navigation with Nav2",t={},c=[{value:"Learning Objectives",id:"learning-objectives",level:2},{value:"Introduction",id:"introduction",level:2},{value:"1. Nav2 Stack Overview",id:"1-nav2-stack-overview",level:2},{value:"Architecture",id:"architecture",level:3},{value:"Key Components",id:"key-components",level:3},{value:"Communication Pattern",id:"communication-pattern",level:3},{value:"2. Costmaps and Planning",id:"2-costmaps-and-planning",level:2},{value:"Costmap Representation",id:"costmap-representation",level:3},{value:"Costmap Layers",id:"costmap-layers",level:3},{value:"Path Planning Algorithms",id:"path-planning-algorithms",level:3},{value:"Global vs Local Costmaps",id:"global-vs-local-costmaps",level:3},{value:"3. Behavior Trees",id:"3-behavior-trees",level:2},{value:"What Are Behavior Trees?",id:"what-are-behavior-trees",level:3},{value:"Default Navigation Behavior Tree",id:"default-navigation-behavior-tree",level:3},{value:"Custom Behavior Tree Example",id:"custom-behavior-tree-example",level:3},{value:"4. Recovery Behaviors",id:"4-recovery-behaviors",level:2},{value:"Why Recovery Behaviors?",id:"why-recovery-behaviors",level:3},{value:"Built-in Recoveries",id:"built-in-recoveries",level:3},{value:"Custom Recovery Behavior",id:"custom-recovery-behavior",level:3},{value:"5. Localization (AMCL)",id:"5-localization-amcl",level:2},{value:"Adaptive Monte Carlo Localization",id:"adaptive-monte-carlo-localization",level:3},{value:"AMCL Configuration",id:"amcl-configuration",level:3},{value:"Using AMCL",id:"using-amcl",level:3},{value:"Debugging Localization",id:"debugging-localization",level:3},{value:"Summary",id:"summary",level:2},{value:"Review Questions",id:"review-questions",level:2},{value:"Hands-on Exercises",id:"hands-on-exercises",level:2},{value:"Exercise 1: Costmap Visualization",id:"exercise-1-costmap-visualization",level:3},{value:"Exercise 2: Custom Behavior Tree",id:"exercise-2-custom-behavior-tree",level:3},{value:"Exercise 3: AMCL Tuning",id:"exercise-3-amcl-tuning",level:3},{value:"Further Reading",id:"further-reading",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"navigation-with-nav2",children:"Navigation with Nav2"})}),"\n",(0,r.jsx)(n.h2,{id:"learning-objectives",children:"Learning Objectives"}),"\n",(0,r.jsx)(n.p,{children:"By the end of this chapter, you will be able to:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Understand the Nav2 stack architecture and its components"}),"\n",(0,r.jsx)(n.li,{children:"Explain how costmaps represent obstacles and free space"}),"\n",(0,r.jsx)(n.li,{children:"Describe path planning algorithms used in Nav2"}),"\n",(0,r.jsx)(n.li,{children:"Understand behavior trees for navigation logic"}),"\n",(0,r.jsx)(n.li,{children:"Implement recovery behaviors for navigation failures"}),"\n",(0,r.jsx)(n.li,{children:"Configure AMCL for robot localization"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,r.jsxs)(n.p,{children:["Autonomous navigation is one of the most challenging and essential capabilities for mobile robots. ",(0,r.jsx)(n.strong,{children:"Nav2 (Navigation 2)"})," is the ROS 2 navigation framework that enables robots to safely navigate from point A to point B while avoiding obstacles, localizing themselves, and recovering from failures."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"The navigation challenge"}),": A mobile robot must:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Know where it is"})," (localization)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Know where to go"})," (goal specification)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Plan a path"})," (global and local planning)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Execute the path"})," (trajectory following)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Avoid obstacles"})," (dynamic and static)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Recover from failures"})," (stuck, lost, blocked)"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Nav2 provides a complete, production-ready solution for these problems, building on decades of research and real-world deployments. It's used in warehouses, hospitals, hotels, factories, and research labs worldwide."}),"\n",(0,r.jsx)(n.p,{children:"This chapter introduces the core concepts of Nav2 and shows how to use its powerful navigation capabilities."}),"\n",(0,r.jsx)(n.h2,{id:"1-nav2-stack-overview",children:"1. Nav2 Stack Overview"}),"\n",(0,r.jsx)(n.h3,{id:"architecture",children:"Architecture"}),"\n",(0,r.jsxs)(n.p,{children:["Nav2 follows a ",(0,r.jsx)(n.strong,{children:"layered architecture"})," with multiple specialized servers:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502           Behavior Tree Navigator           \u2502  (Orchestration)\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n    \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 Planner \u2502  \u2502Controller\u2502  \u2502Recoveries\u2502\n    \u2502 Server  \u2502  \u2502  Server  \u2502  \u2502  Server  \u2502\n    \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502            \u2502              \u2502\n    \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502          Costmap 2D                    \u2502  (World representation)\n    \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502                             \u2502\n    \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2510                  \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502  Sensor  \u2502                  \u2502   AMCL   \u2502  (Localization)\n    \u2502  Data    \u2502                  \u2502          \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.h3,{id:"key-components",children:"Key Components"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"1. Planner Server"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Computes ",(0,r.jsx)(n.strong,{children:"global path"})," from start to goal"]}),"\n",(0,r.jsx)(n.li,{children:"Uses graph search algorithms (A*, Dijkstra, Theta*, Smac Planner)"}),"\n",(0,r.jsx)(n.li,{children:"Runs periodically or on-demand"}),"\n",(0,r.jsx)(n.li,{children:"Considers static map and inflated obstacles"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2. Controller Server"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Follows global path with ",(0,r.jsx)(n.strong,{children:"local trajectory"})]}),"\n",(0,r.jsx)(n.li,{children:"Avoids dynamic obstacles"}),"\n",(0,r.jsx)(n.li,{children:"Uses DWA (Dynamic Window Approach), TEB, MPPI, RPP"}),"\n",(0,r.jsx)(n.li,{children:"Runs at high frequency (10-20 Hz)"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"3. Recoveries Server"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Executes recovery behaviors when stuck"}),"\n",(0,r.jsx)(n.li,{children:"Includes: rotate in place, back up, wait, clear costmap"}),"\n",(0,r.jsx)(n.li,{children:"Prevents robot from getting permanently stuck"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"4. Behavior Tree Navigator"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Coordinates all servers"}),"\n",(0,r.jsx)(n.li,{children:"Implements navigation logic as behavior trees"}),"\n",(0,r.jsx)(n.li,{children:"Customizable for different applications"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"5. Costmap 2D"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Represents environment as occupancy grid"}),"\n",(0,r.jsx)(n.li,{children:"Fuses sensor data (LiDAR, depth cameras)"}),"\n",(0,r.jsx)(n.li,{children:"Inflates obstacles for safety"}),"\n",(0,r.jsx)(n.li,{children:"Global and local costmaps"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"6. AMCL (Adaptive Monte Carlo Localization)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Estimates robot pose on known map"}),"\n",(0,r.jsx)(n.li,{children:"Uses particle filter algorithm"}),"\n",(0,r.jsx)(n.li,{children:"Fuses odometry and laser scans"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"communication-pattern",children:"Communication Pattern"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from nav2_simple_commander.robot_navigator import BasicNavigator\nimport rclpy\n\nclass NavigationExample:\n    def __init__(self):\n        rclpy.init()\n        self.navigator = BasicNavigator()\n\n        # Wait for Nav2 to be ready\n        self.navigator.waitUntilNav2Active()\n\n    def navigate_to_pose(self, x, y, theta):\n        \"\"\"Navigate to a goal pose\"\"\"\n        from geometry_msgs.msg import PoseStamped\n\n        goal_pose = PoseStamped()\n        goal_pose.header.frame_id = 'map'\n        goal_pose.header.stamp = self.navigator.get_clock().now().to_msg()\n        goal_pose.pose.position.x = x\n        goal_pose.pose.position.y = y\n        goal_pose.pose.orientation.z = math.sin(theta / 2.0)\n        goal_pose.pose.orientation.w = math.cos(theta / 2.0)\n\n        # Send goal\n        self.navigator.goToPose(goal_pose)\n\n        # Monitor progress\n        while not self.navigator.isTaskComplete():\n            feedback = self.navigator.getFeedback()\n            print(f'Distance remaining: {feedback.distance_remaining:.2f}m')\n            time.sleep(0.5)\n\n        result = self.navigator.getResult()\n        if result == TaskResult.SUCCEEDED:\n            print('Navigation succeeded!')\n        else:\n            print(f'Navigation failed: {result}')\n"})}),"\n",(0,r.jsx)(n.h2,{id:"2-costmaps-and-planning",children:"2. Costmaps and Planning"}),"\n",(0,r.jsx)(n.h3,{id:"costmap-representation",children:"Costmap Representation"}),"\n",(0,r.jsxs)(n.p,{children:["A ",(0,r.jsx)(n.strong,{children:"costmap"})," is a 2D occupancy grid where each cell has a cost value (0-255):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"0"}),": Free space (safe to traverse)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"1-127"}),": Low cost (prefer to avoid)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"128-252"}),": High cost (obstacles nearby)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"253"}),": Inscribed inflated obstacle"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"254"}),": Lethal obstacle (collision)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"255"}),": Unknown space"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"costmap-layers",children:"Costmap Layers"}),"\n",(0,r.jsx)(n.p,{children:"Costmaps are built from multiple layers:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"1. Static Layer"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Loads from pre-built map (from SLAM)"}),"\n",(0,r.jsx)(n.li,{children:"Represents walls, furniture, fixed obstacles"}),"\n",(0,r.jsx)(n.li,{children:"Doesn't change during runtime"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2. Obstacle Layer"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Adds dynamic obstacles from sensors"}),"\n",(0,r.jsx)(n.li,{children:"Uses LiDAR scans, depth cameras"}),"\n",(0,r.jsx)(n.li,{children:"Clears after obstacles move away"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"3. Inflation Layer"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Expands obstacles by robot radius"}),"\n",(0,r.jsx)(n.li,{children:"Creates safety buffer"}),"\n",(0,r.jsx)(n.li,{children:"Exponential cost decay from obstacles"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"4. Voxel Layer (optional)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"3D representation (for stairs, overhangs)"}),"\n",(0,r.jsx)(n.li,{children:"Clears obstacles above ground"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example costmap configuration:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# global_costmap_params.yaml\nglobal_costmap:\n  global_frame: map\n  robot_base_frame: base_link\n  update_frequency: 1.0\n  publish_frequency: 1.0\n  resolution: 0.05  # 5cm cells\n\n  static_layer:\n    plugin: "nav2_costmap_2d::StaticLayer"\n    map_subscribe_transient_local: True\n\n  obstacle_layer:\n    plugin: "nav2_costmap_2d::ObstacleLayer"\n    observation_sources: scan\n    scan:\n      topic: /scan\n      max_obstacle_height: 2.0\n      clearing: True\n      marking: True\n\n  inflation_layer:\n    plugin: "nav2_costmap_2d::InflationLayer"\n    cost_scaling_factor: 3.0\n    inflation_radius: 0.55  # Robot radius + safety margin\n'})}),"\n",(0,r.jsx)(n.h3,{id:"path-planning-algorithms",children:"Path Planning Algorithms"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"1. NavFn Planner (Dijkstra variant)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Guaranteed shortest path"}),"\n",(0,r.jsx)(n.li,{children:"Slower but thorough"}),"\n",(0,r.jsx)(n.li,{children:"Good for simple environments"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2. Smac Planner 2D (State Lattice)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Considers robot kinematics"}),"\n",(0,r.jsx)(n.li,{children:"Smoother paths for car-like robots"}),"\n",(0,r.jsx)(n.li,{children:"Supports Ackermann steering"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"3. Smac Planner Hybrid-A"}),"*"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Best for complex environments"}),"\n",(0,r.jsx)(n.li,{children:"Considers robot shape and turning radius"}),"\n",(0,r.jsx)(n.li,{children:"More computationally expensive"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Choosing a planner:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# planner_server.yaml\nplanner_server:\n  ros__parameters:\n    expected_planner_frequency: 1.0\n    planner_plugins: ["GridBased"]\n    GridBased:\n      plugin: "nav2_navfn_planner/NavfnPlanner"  # or "nav2_smac_planner/SmacPlanner2D"\n      tolerance: 0.5\n      use_astar: true  # A* (true) vs Dijkstra (false)\n'})}),"\n",(0,r.jsx)(n.h3,{id:"global-vs-local-costmaps",children:"Global vs Local Costmaps"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Global Costmap:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Covers entire known map"}),"\n",(0,r.jsx)(n.li,{children:"Low update frequency (1 Hz)"}),"\n",(0,r.jsx)(n.li,{children:"Used for long-range planning"}),"\n",(0,r.jsx)(n.li,{children:"Large footprint in memory"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Local Costmap:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Small window around robot (e.g., 5m x 5m)"}),"\n",(0,r.jsx)(n.li,{children:"High update frequency (5-10 Hz)"}),"\n",(0,r.jsx)(n.li,{children:"Used for local obstacle avoidance"}),"\n",(0,r.jsx)(n.li,{children:"Real-time dynamic obstacle handling"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"3-behavior-trees",children:"3. Behavior Trees"}),"\n",(0,r.jsx)(n.h3,{id:"what-are-behavior-trees",children:"What Are Behavior Trees?"}),"\n",(0,r.jsx)(n.p,{children:"Behavior trees (BTs) are a hierarchical structure for decision-making. In Nav2, they orchestrate the navigation pipeline."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key node types:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Sequence"}),": Executes children left-to-right until one fails"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Fallback (Selector)"}),": Tries children until one succeeds"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Parallel"}),": Executes multiple children simultaneously"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Decorator"}),": Modifies child behavior (retry, timeout, precondition)"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"default-navigation-behavior-tree",children:"Default Navigation Behavior Tree"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:'<root main_tree_to_execute="MainTree">\n  <BehaviorTree ID="MainTree">\n    <RecoveryNode number_of_retries="3">\n      <PipelineSequence>\n        \x3c!-- Compute path --\x3e\n        <ComputePathToPose goal="{goal}"/>\n\n        \x3c!-- Follow path --\x3e\n        <FollowPath path="{path}"/>\n      </PipelineSequence>\n\n      \x3c!-- Recovery behaviors if navigation fails --\x3e\n      <Fallback>\n        <ClearEntireCostmap/>\n        <Spin spin_dist="1.57"/>  \x3c!-- 90 degrees --\x3e\n        <Wait wait_duration="5"/>\n        <BackUp backup_dist="0.3" backup_speed="0.1"/>\n      </Fallback>\n    </RecoveryNode>\n  </BehaviorTree>\n</root>\n'})}),"\n",(0,r.jsx)(n.h3,{id:"custom-behavior-tree-example",children:"Custom Behavior Tree Example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:'\x3c!-- Navigate with battery check --\x3e\n<root>\n  <BehaviorTree ID="NavigateWithBatteryCheck">\n    <Sequence>\n      \x3c!-- Pre-check: Battery OK? --\x3e\n      <IsBatteryOK min_battery="20.0"/>\n\n      \x3c!-- Main navigation --\x3e\n      <RecoveryNode number_of_retries="2">\n        <PipelineSequence>\n          <ComputePathToPose goal="{goal}"/>\n          <FollowPath path="{path}"/>\n        </PipelineSequence>\n        <RecoveryFallback>\n          <Spin/>\n          <BackUp/>\n        </RecoveryFallback>\n      </RecoveryNode>\n\n      \x3c!-- Post-check: Send completion message --\x3e\n      <PublishNavigationComplete/>\n    </Sequence>\n  </BehaviorTree>\n</root>\n'})}),"\n",(0,r.jsx)(n.h2,{id:"4-recovery-behaviors",children:"4. Recovery Behaviors"}),"\n",(0,r.jsx)(n.h3,{id:"why-recovery-behaviors",children:"Why Recovery Behaviors?"}),"\n",(0,r.jsx)(n.p,{children:"Robots get stuck due to:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Dead ends"}),"\n",(0,r.jsx)(n.li,{children:"Dynamic obstacles (people, doors)"}),"\n",(0,r.jsx)(n.li,{children:"Sensor noise"}),"\n",(0,r.jsx)(n.li,{children:"Localization errors"}),"\n",(0,r.jsx)(n.li,{children:"Unexpected obstacles"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Recovery behaviors provide graceful failure handling."}),"\n",(0,r.jsx)(n.h3,{id:"built-in-recoveries",children:"Built-in Recoveries"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"1. Spin"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Rotate in place (360\xb0 or specified angle)"}),"\n",(0,r.jsx)(n.li,{children:"Helps relocalize (AMCL)"}),"\n",(0,r.jsx)(n.li,{children:"Finds alternate path after rotating"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# recoveries_server.yaml\nrecoveries_server:\n  ros__parameters:\n    costmap_topic: local_costmap/costmap_raw\n    footprint_topic: local_costmap/published_footprint\n    recovery_plugins: ["spin", "backup", "wait"]\n\n    spin:\n      plugin: "nav2_recoveries/Spin"\n      simulate_ahead_time: 2.0\n\n    backup:\n      plugin: "nav2_recoveries/BackUp"\n      simulate_ahead_time: 2.0\n\n    wait:\n      plugin: "nav2_recoveries/Wait"\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2. Back Up"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Reverse along current heading"}),"\n",(0,r.jsx)(n.li,{children:"Useful when robot is too close to obstacle"}),"\n",(0,r.jsx)(n.li,{children:"Configurable distance and speed"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"3. Wait"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Pause for specified duration"}),"\n",(0,r.jsx)(n.li,{children:"Allows dynamic obstacles to clear"}),"\n",(0,r.jsx)(n.li,{children:"Useful in crowded environments"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"4. Clear Costmap"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Removes sensor artifacts"}),"\n",(0,r.jsx)(n.li,{children:"Helps with false detections"}),"\n",(0,r.jsx)(n.li,{children:"Use sparingly (can be dangerous)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"custom-recovery-behavior",children:"Custom Recovery Behavior"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from nav2_msgs.action import BackUp\nimport rclpy\nfrom rclpy.node import Node\nfrom rclpy.action import ActionClient\n\nclass ManualRecovery(Node):\n    def __init__(self):\n        super().__init__('manual_recovery')\n        self.backup_client = ActionClient(self, BackUp, 'backup')\n\n    def execute_recovery(self):\n        \"\"\"Back up 0.3m at 0.1 m/s\"\"\"\n        goal = BackUp.Goal()\n        goal.target.x = -0.3  # Negative = backward\n        goal.speed = 0.1\n\n        self.backup_client.wait_for_server()\n        future = self.backup_client.send_goal_async(goal)\n        rclpy.spin_until_future_complete(self, future)\n\n        if future.result().accepted:\n            self.get_logger().info('Recovery initiated')\n        else:\n            self.get_logger().error('Recovery rejected')\n"})}),"\n",(0,r.jsx)(n.h2,{id:"5-localization-amcl",children:"5. Localization (AMCL)"}),"\n",(0,r.jsx)(n.h3,{id:"adaptive-monte-carlo-localization",children:"Adaptive Monte Carlo Localization"}),"\n",(0,r.jsx)(n.p,{children:"AMCL estimates robot pose using:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Laser scan"})," matching against known map"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Odometry"})," for motion model"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Particle filter"})," for probabilistic estimation"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"How it works:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Initialization"}),": Scatter particles across map (or near known pose)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Prediction"}),": Move particles based on odometry"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Update"}),": Weight particles by laser scan match quality"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Resampling"}),": Replace low-weight particles with high-weight copies"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Pose estimate"}),": Weighted average of particles"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"amcl-configuration",children:"AMCL Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# amcl.yaml\namcl:\n  ros__parameters:\n    # Particle filter\n    min_particles: 500\n    max_particles: 2000\n\n    # Odometry model (differential drive)\n    odom_model_type: "diff-corrected"\n    odom_alpha1: 0.2  # Rotation noise from rotation\n    odom_alpha2: 0.2  # Rotation noise from translation\n    odom_alpha3: 0.2  # Translation noise from translation\n    odom_alpha4: 0.2  # Translation noise from rotation\n\n    # Laser model\n    laser_model_type: "likelihood_field"\n    laser_max_range: 12.0\n    laser_min_range: 0.1\n    laser_likelihood_max_dist: 2.0\n\n    # Update rates\n    update_min_d: 0.2  # Min translation before update (m)\n    update_min_a: 0.5  # Min rotation before update (rad)\n    resample_interval: 1\n\n    # Initial pose\n    set_initial_pose: true\n    initial_pose:\n      x: 0.0\n      y: 0.0\n      z: 0.0\n      yaw: 0.0\n'})}),"\n",(0,r.jsx)(n.h3,{id:"using-amcl",children:"Using AMCL"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from geometry_msgs.msg import PoseWithCovarianceStamped\nimport rclpy\nfrom rclpy.node import Node\n\nclass LocalizationMonitor(Node):\n    def __init__(self):\n        super().__init__(\'localization_monitor\')\n\n        # Subscribe to AMCL pose\n        self.pose_sub = self.create_subscription(\n            PoseWithCovarianceStamped,\n            \'/amcl_pose\',\n            self.pose_callback,\n            10\n        )\n\n        # Publish initial pose (optional)\n        self.init_pose_pub = self.create_publisher(\n            PoseWithCovarianceStamped,\n            \'/initialpose\',\n            10\n        )\n\n    def pose_callback(self, msg):\n        """Monitor localization quality"""\n        # Extract pose\n        x = msg.pose.pose.position.x\n        y = msg.pose.pose.position.y\n\n        # Extract covariance (uncertainty)\n        cov_x = msg.pose.covariance[0]   # Variance in x\n        cov_y = msg.pose.covariance[7]   # Variance in y\n        cov_yaw = msg.pose.covariance[35]  # Variance in yaw\n\n        # Check localization quality\n        if cov_x > 0.5 or cov_y > 0.5:\n            self.get_logger().warn(\'High localization uncertainty!\')\n\n    def set_initial_pose(self, x, y, yaw):\n        """Manually set robot\'s initial pose"""\n        msg = PoseWithCovarianceStamped()\n        msg.header.frame_id = \'map\'\n        msg.header.stamp = self.get_clock().now().to_msg()\n\n        msg.pose.pose.position.x = x\n        msg.pose.pose.position.y = y\n        msg.pose.pose.orientation.z = math.sin(yaw / 2.0)\n        msg.pose.pose.orientation.w = math.cos(yaw / 2.0)\n\n        # Set covariance (initial uncertainty)\n        msg.pose.covariance[0] = 0.5  # x\n        msg.pose.covariance[7] = 0.5  # y\n        msg.pose.covariance[35] = 0.1  # yaw\n\n        self.init_pose_pub.publish(msg)\n'})}),"\n",(0,r.jsx)(n.h3,{id:"debugging-localization",children:"Debugging Localization"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Common issues:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Robot kidnapped (teleported)"}),": AMCL can't recover"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Solution: Use global localization (",(0,r.jsx)(n.code,{children:"request_nomotion_update"}),")"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"High uncertainty"}),": Covariance keeps growing"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Solution: Check laser scan quality, reduce odometry noise parameters"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"False localization"}),": Robot thinks it's somewhere else"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Solution: More particles, better laser scan, distinctive features in map"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsx)(n.p,{children:"Key takeaways:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Nav2"})," provides production-ready autonomous navigation for ROS 2"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Costmaps"})," represent obstacles with multiple layers (static, obstacle, inflation)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Planners"})," compute global paths using graph search algorithms"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Controllers"})," follow paths while avoiding dynamic obstacles"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Behavior trees"})," orchestrate the navigation pipeline with recovery logic"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"AMCL"})," localizes the robot on known maps using particle filters"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Recovery behaviors"})," handle navigation failures gracefully"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Navigation pipeline:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"AMCL estimates robot pose"}),"\n",(0,r.jsx)(n.li,{children:"Planner computes global path"}),"\n",(0,r.jsx)(n.li,{children:"Controller follows path locally"}),"\n",(0,r.jsx)(n.li,{children:"If stuck \u2192 Execute recovery behaviors"}),"\n",(0,r.jsx)(n.li,{children:"Repeat until goal reached"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"review-questions",children:"Review Questions"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"What is the difference between a global costmap and a local costmap?"}),"\n",(0,r.jsx)(n.li,{children:"Why does Nav2 use both a planner server and a controller server?"}),"\n",(0,r.jsx)(n.li,{children:"How does the inflation layer improve navigation safety?"}),"\n",(0,r.jsx)(n.li,{children:"What is the purpose of behavior trees in Nav2?"}),"\n",(0,r.jsx)(n.li,{children:"How does AMCL estimate robot pose?"}),"\n",(0,r.jsx)(n.li,{children:"When would you use a recovery behavior instead of replanning?"}),"\n",(0,r.jsx)(n.li,{children:"What are the advantages of using Smac Planner over NavFn Planner?"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"hands-on-exercises",children:"Hands-on Exercises"}),"\n",(0,r.jsx)(n.h3,{id:"exercise-1-costmap-visualization",children:"Exercise 1: Costmap Visualization"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Launch Nav2 with TurtleBot3 simulation"}),"\n",(0,r.jsx)(n.li,{children:"Visualize global and local costmaps in RViz"}),"\n",(0,r.jsx)(n.li,{children:"Observe how costmaps update as robot moves"}),"\n",(0,r.jsx)(n.li,{children:"Add dynamic obstacles and watch inflation"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"exercise-2-custom-behavior-tree",children:"Exercise 2: Custom Behavior Tree"}),"\n",(0,r.jsx)(n.p,{children:"Create a behavior tree that:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Checks battery level before navigating"}),"\n",(0,r.jsx)(n.li,{children:"Navigates to charging station if battery low"}),"\n",(0,r.jsx)(n.li,{children:"Uses recovery behaviors if path blocked"}),"\n",(0,r.jsx)(n.li,{children:"Sends notification when goal reached"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"exercise-3-amcl-tuning",children:"Exercise 3: AMCL Tuning"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Run AMCL with default parameters"}),"\n",(0,r.jsx)(n.li,{children:"Measure localization accuracy (error from ground truth)"}),"\n",(0,r.jsx)(n.li,{children:"Adjust particle count, noise parameters"}),"\n",(0,r.jsx)(n.li,{children:"Compare before/after localization quality"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"further-reading",children:"Further Reading"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://navigation.ros.org/",children:"Nav2 Official Documentation"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://arxiv.org/abs/1709.00084",children:"Behavior Trees in Robotics"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"http://robots.stanford.edu/papers/fox.aaai99.pdf",children:"AMCL Algorithm"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://navigation.ros.org/tutorials/index.html",children:"Nav2 Tutorials"})}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Next Chapter"}),": ",(0,r.jsx)(n.a,{href:"/AI_COURSE_book/docs/module-02-digital-twin/week-06/ch07-gazebo-physics",children:"Module 2: Gazebo Physics Simulation \u2192"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Previous Chapter"}),": ",(0,r.jsx)(n.a,{href:"/AI_COURSE_book/docs/module-01-ros2/week-05/ch05-urdf-models",children:"\u2190 URDF Robot Models"})]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>o});var s=i(6540);const r={},a=s.createContext(r);function l(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);